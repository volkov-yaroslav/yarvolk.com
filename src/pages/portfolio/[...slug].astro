---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

import PortfolioCard from "@components/PortfolioCard.astro";
import Layout from '@layouts/Layout.astro';
import { markdownify } from "@lib/utils/textConverter";

export async function getStaticPaths() {
  const allPortfolioItems: CollectionEntry<"portfolio">[] = await getCollection("portfolio");
  const publishedPortfolioItems = allPortfolioItems.filter(item => !item.data.draft);

  const sortedPortfolioItems = publishedPortfolioItems.sort((a, b) =>
    new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
  );

  return publishedPortfolioItems.map((portfolioItem, index) => {
    const previousPortfolioItem = sortedPortfolioItems[index - 1] || null;
    const nextPortfolioItem = sortedPortfolioItems[index + 1] || null;
    const relatedPortfolioItems = sortedPortfolioItems
      .filter((item) => item.slug !== portfolioItem.slug)
      .slice(0, 3);

    return {
      params: { slug: portfolioItem.slug },
      props: { portfolioItem, previousPortfolioItem, nextPortfolioItem, relatedPortfolioItems },
    };
  });
}

const { portfolioItem, previousPortfolioItem, nextPortfolioItem, relatedPortfolioItems } = Astro.props;

const { title, description, image, category, projectInfo } = portfolioItem.data;

const { Content } = await portfolioItem.render();
---

<Layout title={title} description={description} image={image}>
  <section class="pt-16 md:pt-24 pb-20 md:pb-28">
    <div class="container">
      <div class="row justify-center">
        <div class="lg:col-8 text-center banner mb-12 md:mb-16" data-aos="fade-up-sm">
          <span class="inline-block text-sm rounded-full bg-[#efefef] px-3 py-1 capitalize text-black mb-8">{category}</span>
          <h1 class="text-4xl md:text-5xl mb-4 !leading-tight text-balance">{title}</h1>
          <p class="max-w-xl mx-auto text-balance">{description}</p>
        </div>

        <div class="lg:col-10 mb-10 md:mb-12" data-aos="fade-up-sm" data-aos-delay="80">
          <ul class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 text-white">
            {projectInfo.map((item: any) => (
              <li class="min-w-0 h-full rounded-lg bg-light/10 hover:bg-light/20 transition-colors duration-300 p-5 sm:p-6">
                <p class="text-white/50 text-xs uppercase tracking-wider mb-2 text-left">
                  {item.title}
                </p>
                <div
                  class="text-left break-words [overflow-wrap:anywhere] [&_a]:underline [&_a]:hover:no-underline [&_a]:break-all [&_ul]:list-disc [&_ul]:pl-5 [&_ul]:space-y-1 [&_li]:mt-1"
                  set:html={markdownify(item.data, true)}
                ></div>
              </li>
            ))}
          </ul>
        </div>

        <div class="lg:col-10 mx-auto" data-aos="fade-up-sm" data-aos-delay="100">
          <img
            class="aspect-[5/3] object-cover object-center rounded-lg bg-light/20 w-full"
            src={image}
            alt={title}
            width={`1600`}
            height={`960`}
          />
        </div>

        <div class="lg:col-8">
          <hr class="opacity-5 mt-16 md:mt-20 mb-16 md:mb-24" />
        </div>
      </div>

      <div class="row justify-center" data-aos="fade-in">
        <div class="lg:col-8">
          <article class="content content-light [&_img]:w-full">
             <Content />
          </article>
        </div>
      </div>
    </div>
  </section>

  <section class="py-20 md:py-28 bg-white text-dark rounded-b-2xl overflow-hidden">
    <div class="container">
      <div class="mb-16">
        <h2 class="text-4xl md:text-5xl font-secondary font-medium -mt-[6px] text-center">
          More Work
        </h2>
      </div>
      <div class="row md:gx-4 gy-4">
        {relatedPortfolioItems.map((item, index) => (
          <div
            class="lg:col-4 md:col-6 init-delay"
            data-aos="fade-up-sm"
            data-aos-duration="500"
            style={{
              "--lg-delay": `${(index % 3) * 75}ms`,
              "--md-delay": `${(index % 2) * 75}ms`,
              "--sm-delay": `${(index % 2) * 75}ms`
            }}
          >
            <PortfolioCard slug={item.slug} data={item.data} twoColumns={false} />
          </div>
        ))}
      </div>
    </div>
  </section>

</Layout>
